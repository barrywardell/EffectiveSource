/*******************************************************************************
 * Copyright (C) 2012 Barry Wardell
 *
 * Authors: Barry Wardell <effectivesource@barrywardell.net>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston MA 02110-1301, USA.
 *
 * Version 3.0 beta 2 - 30 May 2012
 *
 * This code compute the singular field and effective source for a point scalar
 * particle following an equatorial geodesic orbit in Kerr.
 *
 * Definitions: x is the 4-dimensional location of the field point, xp is the
 *        location of the particle. M is the mass of the background Kerr black
 *        hole. a = J/M is the spin of the black hole in units of M.
 *
 * Usage: Call effsource_init(M, a) at startup to set the mass and spin of the
 *        central black hole.
 *
 *        Call either effsource_set_particle(x_p, u_p) or
 *        effsource_set_particle_el(x_p, e, l, ur_p) every time the particle's
 *        position (x_p), velocity (u_p, ur_p) or constants of motion (e, l) change.
 *
 *        effsource_phis(x, *phis) stores the value of the singular field in phis
 *
 *        effsource_calc(x, *phis, *dphis_dr, *dphis_dth, *dphis_dph, *box_phis)
 *        computes the singular field, its spatial derivatives and its
 *        d'Alembertian and stores them in the variables phis, dphis_dr,
 *        dphis_dth, dphis_dph and box_phis.
 *
 */

#include <math.h>
#include <assert.h>
#include "effsource.h"
#include <stdio.h>
#include <gsl/gsl_sf_ellint.h>

/* The particle's coordinate location and 4-velocity */
extern struct coordinate xp;

/* Mass and spin of the Kerr black hole */
extern double M, a;

/* Static variables used to store the coefficients of the series expansions */
extern double A0060, A0061, A0080, A0081, A0240, A0241, A0260, A0261, A0420, A0421, A0440, A0441, A0600, A0601, A0620, A0621, A0800, A0801, A1060, A1061, A1080, A1240, A1241, A1260, A1420, A1421, A1440, A1600, A1601, A1620, A1800, A2040, A2041, A2060, A2061, A2220, A2221, A2240, A2241, A2400, A2401, A2420, A2421, A2600, A2601, A3040, A3041, A3060, A3220, A3221, A3240, A3400, A3401, A3420, A3600, A4020, A4021, A4040, A4041, A4200, A4201, A4220, A4221, A4400, A4401, A5020, A5021, A5040, A5200, A5201, A5220, A5400, A6000, A6001, A6020, A6021, A6200, A6201, A7000, A7001, A7020, A7200, A8000, A8001, A9000;
extern double alpha20, alpha02, beta;

/* Numerical coefficients appearing in the elliptic integrals expressions. The
   indices here correspond to mode m, EllipticK/EllipticE, order in Sin[dphi],
   term in polynomial in alpha/beta. */
static const double EI[11][2][5][17] =
  {
    /* m=0 */
    {
      {
        {0,-0.26666666666666666,-0.5333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0.4,0.13333333333333333,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,1,1.2666666666666666,0.5333333333333333,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,-4,-6.933333333333334,-3.2,0,0,0,0,0,0,0,0,0,0}
      },
      {
        {0.5333333333333333,1.5333333333333334,1.5333333333333334,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0.13333333333333333,0.4666666666666667,-0.2,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0.2,-0.4666666666666667,-0.13333333333333333,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,-1.5333333333333334,-1.5333333333333334,-0.5333333333333333,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,1,6.866666666666666,8.533333333333333,3.2,0,0,0,0,0,0,0,0,0,0}
      }
    },

    /* m=1 */
    {
      {
        {0,-0.26666666666666666,-0.4,-0.4,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,-0.6,-0.26666666666666666,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,-1.6,-2.4,-1.0666666666666667,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,1,9.266666666666667,14.4,6.4,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,-3.3333333333333335,-24.933333333333334,-38.4,-17.066666666666666,0,0,0,0,0,0,0,0,0}
      },
      {
        {0.5333333333333333,1.2666666666666666,0.6,0.4,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0.13333333333333333,0.06666666666666667,0.7333333333333333,0.26666666666666666,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0.2,2.6,2.933333333333333,1.0666666666666667,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,-3.533333333333333,-15.266666666666667,-17.6,-6.4,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,-0.3333333333333333,10.2,40.93333333333333,46.93333333333333,17.066666666666666,0,0,0,0,0,0,0,0,0}
      }
    },

    /* m=2 */
    {
      {
        {0,-0.26666666666666666,0,1.6,1.0666666666666667,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,5,9.066666666666666,4.266666666666667,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,-7.6,-42,-59.733333333333334,-25.6,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,1,30.6,128,166.4,68.26666666666667,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,-3.466666666666667,-73.6,-275.2,-341.3333333333333,-136.53333333333333,0,0,0,0,0,0,0,0}
        
      },
      {
        {0.5333333333333333,0.4666666666666667,-0.6,-2.1333333333333333,-1.0666666666666667,0,0,0,0,0,0,0,0,0,0,0,0},{0,0.13333333333333333,-1.1333333333333333,-8.733333333333333,-11.2,-4.266666666666667,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0.2,19.8,67.06666666666666,72.53333333333333,25.6,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,-4.2,-69.8,-198.4,-200.53333333333333,-68.26666666666667,0,0,0,0,0,0,0,0,0},
        {0,0,0,-0.06666666666666667,13.266666666666667,160,420.26666666666665,409.6,136.53333333333333,0,0,0,0,0,0,0,0}
      }
    },

    /* m=3 */
    {
      {
        {0,-0.26666666666666666,0.6666666666666666,-16.4,-34.13333333333333,-17.066666666666666,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,41,186.4,247.46666666666667,102.4,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,-17.6,-204,-630.4,-716.8,-273.06666666666666,0,0,0,0,0,0,0,0,0},
        {0,0,0,1,65.8,536,1427.2,1501.8666666666666,546.1333333333333,0,0,0,0,0,0,0,0},
        {0,0,0,0,-3.4857142857142858,-153.0857142857143,-1073.3714285714286,-2640.457142857143,-2652.647619047619,-936.2285714285714,0,0,0,0,0,0,0}
      },
      {
        {0.5333333333333333,-0.8666666666666667,2.7333333333333334,30.266666666666666,42.666666666666664,17.066666666666666,0,0,0,0,0,0,0,0,0,0,0},
        {0,0.13333333333333333,-3.1333333333333333,-97.4,-290.93333333333334,-298.6666666666667,-102.4,0,0,0,0,0,0,0,0,0,0},
        {0,0,0.2,53.8,410.4,937.6,853.3333333333334,273.06666666666666,0,0,0,0,0,0,0,0,0},
        {0,0,0,-4.6,-177.4,-1019.2,-2075.733333333333,-1774.9333333333334,-546.1333333333333,0,0,0,0,0,0,0,0},
        {0,0,0,-0.02857142857142857,14.771428571428572,392.62857142857143,1984,3791.2380952380954,3120.7619047619046,936.2285714285714,0,0,0,0,0,0,0}
      }
    },

    /* m=4 */
    {
      {
        {0,-0.26666666666666666,1.6,-198.4,-814.9333333333333,-1024,-409.6,0,0,0,0,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,147.4,1179.7333333333333,3012.266666666667,3072,1092.2666666666667,0,0,0,0,0,0,0,0,0},
        {0,0,0,-31.6,-629.2,-3345.0666666666666,-7116.8,-6553.6,-2184.5333333333333,0,0,0,0,0,0,0,0},
        {0,0,0,1,114.94285714285714,1556.3428571428572,6981.4857142857145,13497.295238095237,11702.857142857143,3744.9142857142856,0,0,0,0,0,0,0},
        {0,0,0,0,-3.492063492063492,-263.84761904761905,-3017.295238095238,-12327.009523809524,-22469.485714285714,-18724.571428571428,-5825.422222222222,0,0,0,0,0,0}
      },
      {
        {0.5333333333333333,-2.7333333333333334,18.6,452.26666666666665,1250.1333333333334,1228.8,409.6,0,0,0,0,0,0,0,0,0,0},
        {0,0.13333333333333333,-5.933333333333334,-401.26666666666665,-2212.266666666667,-4343.466666666666,-3618.133333333333,-1092.2666666666667,0,0,0,0,0,0,0,0,0},
        {0,0,0.2,106.2,1463.3333333333333,5879.466666666666,9984,7645.866666666667,2184.5333333333333,0,0,0,0,0,0,0,0},
        {0,0,0,-4.885714285714286,-344.0857142857143,-3410.5142857142855,-11886.933333333332,-18646.55238095238,-13575.314285714287,-3744.9142857142856,0,0,0,0,0,0,0},
        {0,0,0,-0.015873015873015872,15.806349206349207,753.3714285714286,6407.466666666666,20597.02857142857,30739.504761904762,21637.28253968254,5825.422222222222,0,0,0,0,0,0}
      }
    },

    /* m=5 */
    {
      {
        {0,-0.26666666666666666,2.8,-970,-6314.666666666667,-14080,-13107.2,-4369.066666666667,0,0,0,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,380.2,4689.866666666667,19157.333333333332,34508.8,28398.933333333334,8738.133333333333,0,0,0,0,0,0,0,0},
        {0,0,0,-49.6,-1514.1714285714286,-12285.104761904762,-41442.74285714285,-66823.31428571428,-51180.49523809524,-14979.657142857142,0,0,0,0,0,0,0},
        {0,0,0,1,178.05396825396826,3632.0761904761903,24604.95238095238,74800.76190476191,112737.52380952382,82388.11428571428,23301.68888888889,0,0,0,0,0,0},
        {0,0,0,0,-3.494949494949495,-405.9919191919192,-6920.145454545454,-42364.121212121216,-120645.81818181818,-173769.69696969696,-122863.45050505051,-33893.36565656566,0,0,0,0,0}
        
      },
      {
        {0.5333333333333333,-5.133333333333334,58.2,2479.3333333333335,11306.666666666666,19814.4,15291.733333333334,4369.066666666667,0,0,0,0,0,0,0,0,0},
        {0,0.13333333333333333,-9.533333333333333,-1129.9333333333334,-9986.933333333332,-31906.133333333335,-47069.86666666667,-32768,-8738.133333333333,0,0,0,0,0,0,0,0},
        {0,0,0.2,178.14285714285714,3892.609523809524,24463.390476190478,66662.4,89604.87619047619,58670.32380952381,14979.657142857142,0,0,0,0,0,0,0},
        {0,0,0,-5.1079365079365076,-573.9968253968254,-8815.314285714287,-47328,-117906.28571428571,-149562.51428571428,-94038.95873015873,-23301.68888888889,0,0,0,0,0,0},
        {0,0,0,-0.010101010101010102,16.6,1251.761616161616,16279.660606060606,79786.66666666667,187671.27272727274,228846.41616161616,139810.13333333333,33893.36565656566,0,0,0,0,0}
      }
    },

    /* m=6 */
    {
      {
        {0,-0.26666666666666666,4.266666666666667,-3262.4,-30573.866666666665,-103765.33333333333,-163840,-122333.86666666667,-34952.53333333333,0,0,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,811.4,14256.685714285713,84442.81904761905,231716.57142857142,322998.85714285716,222198.24761904762,59918.62857142857,0,0,0,0,0,0,0},
        {0,0,0,-71.6,-3111.35873015873,-35753.44761904762,-174188.49523809523,-426296.0761904762,-551126.5523809524,-359511.77142857143,-93206.75555555556,0,0,0,0,0,0},
        {0,0,0,1,255.14487734487736,7331.7772005772,69909.00086580086,305560.71341991343,696355.4632034632,856110.1021645021,538057.1797979798,135573.46262626263,0,0,0,0,0},
        {0,0,0,0,-3.4965034965034967,-579.5630147630147,-13824.999533799533,-118555.33053613054,-483592.47365967365,-1.0497981165501166e6,-1.2450923412587412e6,-761297.1362859363,-187717.1020979021,0,0,0,0}
      },
      {
        {0.5333333333333333,-8.066666666666666,135.93333333333334,9026.133333333333,61310.933333333334,166024.53333333333,218453.33333333334,139810.13333333333,34952.53333333333,0,0,0,0,0,0,0,0},
        {0,0.13333333333333333,-13.933333333333334,-2571.1714285714284,-33332.038095238095,-157322.3619047619,-357171.2,-422863.2380952381,-252157.5619047619,-59918.62857142857,0,0,0,0,0,0,0},
        {0,0,0.2,270.5174603174603,8617.873015873016,78308.57142857143,312652.8,643189.0285714286,713406.1714285715,406115.1492063492,93206.75555555556,0,0,0,0,0,0},
        {0,0,0,-5.28975468975469,-870.3079365079365,-19227.160750360752,-147887.70909090908,-536312.6857142857,-1.0362348051948051e6,-1.0997186678210679e6,-605843.911111111,-135573.46262626263,0,0,0,0,0},
        {0,0,0,-0.006993006993006993,17.244910644910647,1895.0315462315461,35180.35244755245,245442.05874125875,836234.2041958042,1.5471995524475526e6,1.5905439527583527e6,855155.6873348873,187717.1020979021,0,0,0,0}
      }
    },

    /* m=7 */
    {
      {
        {0,-0.26666666666666666,6,-8800.4,-111859.80952380953,-531221.9428571429,-1.2414390857142857e6,-1.5322940952380951e6,-958698.0571428571,-239674.51428571428,0,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,1529,36268.93968253968,292742.09523809527,1.1256783238095238e6,2.3227830857142857e6,2.6401645714285714e6,1.557884342857143e6,372827.02222222224,0,0,0,0,0,0},
        {0,0,0,-97.6,-5729.1255411255415,-88548.89927849927,-586570.2510822511,-2.0080116917748917e6,-3.8364944623376625e6,-4.1284842943722946e6,-2.3386422303030305e6,-542293.8505050505,0,0,0,0,0},
        {0,0,0,1,346.2218004218004,13349.73026973027,170513.0474858475,1.0105419870795871e6,3.214343297236097e6,5.829024556243756e6,6.033182035742036e6,3.3163354703962705e6,750868.4083916084,0,0,0,0},
        {0,0,0,0,-3.4974358974358974,-784.5839937839938,-25005.26247086247,-286327.7053613054,-1.5797995114219114e6,-4.77710082983683e6,-8.342656417715617e6,-8.387304409013209e6,-4.50521045034965e6,-1.0011578778554779e6,0,0,0}
      },
      {
        {0.5333333333333333,-11.533333333333333,269.4,25857.619047619046,244643.3523809524,941524.1142857143,1.8502997333333334e6,1.9667041523809524e6,1.0785353142857142e6,239674.51428571428,0,0,0,0,0,0,0},
        {0,0.13333333333333333,-19.133333333333333,-5094.479365079365,-91148.63492063493,-595972.8761904762,-1.9178837333333334e6,-3.3857145904761907e6,-3.3492016761904764e6,-1.744297853968254e6,-372827.02222222224,0,0,0,0,0,0},
        {0,0,0.2,384.0510822510823,16824.368253968252,209062.3953823954,1.1501940363636364e6,3.3420239238095237e6,5.513081239826839e6,5.196125312554113e6,2.6097891555555556e6,542293.8505050505,0,0,0,0,0},
        {0,0,0,-5.443600843600843,-1235.5986901986903,-37219.1333999334,-389168.827972028,-1.9364873206793207e6,-5.267843912887113e6,-8.294196586702187e6,-7.550561944366745e6,-3.6917696745920745e6,-750868.4083916084,0,0,0,0},
        {0,0,0,-0.005128205128205128,17.78850038850039,2689.031546231546,67733.57202797203,639727.53006993,2.9806964363636365e6,7.743910966899767e6,1.1785440213830614e7,1.0452192532090131e7,5.005789389277389e6,1.0011578778554779e6,0,0,0}
      }
    },

    /* m=8 */
    {
      {
        {0,-0.26666666666666666,8,-20454.4,-338221.5111111111,-2.129646933333333e6,-6.821751466666667e6,-1.2233386666666666e7,-1.2443101866666667e7,-6.7108864e6,-1.491308088888889e6,0,0,0,0,0,0},
        {0,0,-0.06666666666666667,2637,81197.69581529581,855236.9685425685,4.365921080519481e6,1.2354614081385281e7,2.0404108744588744e7,1.9569787234632034e7,1.0100222965656566e7,2.169175402020202e6,0,0,0,0,0},
        {0,0,0,-127.6,-9731.779553779554,-194743.272016872,-1.6810041968697968e6,-7.631895255677655e6,-1.9979235561238762e7,-3.121355504229104e7,-2.8716805848018646e7,-1.4349929582595183e7,-3.0034736335664336e6,0,0,0,0},
        {0,0,0,1,451.2884670884671,22506.019314019315,371138.143989344,2.8608340821844824e6,1.2051529176956376e7,2.991034232967033e7,4.489893256254856e7,4.0046315114219114e7,1.9522578618181817e7,4.0046315114219114e6,0,0,0},
        {0,0,0,0,-3.4980392156862745,-1021.0684583390466,-41964.88205128205,-619011.4680926916,-4.434788679994515e6,-1.7736541547237076e7,-4.234410989606472e7,-6.1679177494547285e7,-5.3709175564952694e7,-2.5676754984999314e7,-5.182464308898944e6,0,0}
      },
      {
        {0.5333333333333333,-15.533333333333333,479.4,63067.02222222222,792570.3111111111,4.1009152e6,1.1153681066666666e7,1.7336456533333335e7,1.55189248e7,7.456540444444444e6,1.491308088888889e6,0,0,0,0,0,0},
        {0,0.13333333333333333,-25.133333333333333,-9153.99163059163,-216262.70476190475,-1.870872972005772e6,-8.079372412121212e6,-1.9716661638095237e7,-2.849857074978355e7,-2.421317832958153e7,-1.1184810666666666e7,-2.169175402020202e6,0,0,0,0,0},
        {0,0,0.2,519.3591075591075,29973.258252858253,488692.7529359529,3.5444105846153847e6,1.3786808101764902e7,3.138413195977356e7,4.3162921822710626e7,3.5328619333022535e7,1.58516663993784e7,3.0034736335664336e6,0,0,0,0},
        {0,0,0,-5.576934176934177,-1672.0434454434455,-65967.23223443223,-901384.234965035,-5.895572075924076e6,-2.1422238766033966e7,-4.646431837318237e7,-6.163704083294483e7,-4.905673601491842e7,-2.1524894373892773e7,-4.0046315114219114e6,0,0,0},
        {0,0,0,-0.00392156862745098,18.25848530554413,3638.6809634809633,119650.73401892226,1.4725623786096256e6,8.997631810448375e6,3.1165726124667488e7,6.523953848801134e7,8.420522974629554e7,6.55758409995338e7,2.8267987139448788e7,5.182464308898944e6,0,0}
      }
    },

    /* m=9 */
    {
      {
        {0,-0.26666666666666666,10.266666666666667,-42656.4,-889373.995959596,-7.149019797979798e6,-2.9865748169696968e7,-7.235293556363636e7,-1.0554394065454546e8,-9.146124722424242e7,-4.3383508040404044e7,-8.676701608080808e6,0,0,0,0,0},
        {0,0,-0.06666666666666667,4255.4,165053.57016317017,2.19670492991453e6,1.4330180624708625e7,5.29140260997669e7,1.1808499516270396e8,1.624359102955711e8,1.346948423011655e8,6.173806913442113e7,1.2013894534265734e7,0,0,0,0},
        {0,0,0,-161.6,-15539.587434787434,-390961.72201132204,-4.259990718614719e6,-2.4699115148318347e7,-8.432809336796537e7,-1.779399951088911e8,-2.3469069971592852e8,-1.8834282577156177e8,-8.409726173986015e7,-1.6018526045687646e7,0,0,0},
        {0,0,0,1,570.3472906178788,35746.582191664544,739622.7686979687,7.187172049660143e6,3.862786977665472e7,1.249378262920452e8,2.5314112267361397e8,3.234930047362311e8,2.531309910877828e8,1.1071628296284108e8,2.0729857235595778e7,0,0},
        {0,0,0,0,-3.498452012383901,-1289.0251146857959,-66438.47422257825,-1.227617738434115e6,-1.107397992473244e7,-5.645272137256345e7,-1.7550347663965014e8,-3.4482027794523466e8,-4.29947715579034e8,-3.2974049077368206e8,-1.4183586529618162e8,-2.6185082823910456e7,0}
      },{
        {0.5333333333333333,-20.066666666666666,789.9333333333333,136892.39191919193,2.2055480888888887e6,1.4743798173737373e7,5.277455204848485e7,1.1157285546666667e8,1.4395359728484848e8,1.115261196929293e8,4.7721858844444446e7,8.676701608080808e6,0,0,0,0,0},
        {0,0.13333333333333333,-31.933333333333334,-15290.940326340326,-461269.8076146076,-5.10054407956488e6,-2.841850342937063e7,-9.11948410927739e7,-1.7918446766247088e8,-2.193337460960373e8,-1.6331127164320123e8,-6.7745016401554e7,-1.2013894534265734e7,0,0,0,0},
        {0,0,0.2,676.9748695748696,49810.32203352203,1.0321920394272394e6,9.544164072727272e6,4.781388058341658e7,1.4294413774385613e8,2.6698699182559663e8,3.145956128422688e8,2.2738798300792542e8,9.210652476270397e7,1.6018526045687646e7,0,0,0},
        {0,0,0,-5.694581235757706,-2181.5221419103773,-109270.05492285492,-1.892202578033731e6,-1.5744906345607335e7,-7.356716086097433e7,-2.0929734465833253e8,-3.7668167367356825e8,-4.312426213404269e8,-3.046022843375291e8,-1.2108121158063897e8,-2.0729857235595778e7,0,0},
        {0,0,0,-0.0030959752321981426,18.672520393263426,4748.226915980476,197766.84242568578,3.0782871159107145e6,2.3888763615371626e7,1.062565981512135e8,2.914255876520172e8,5.098456950542433e8,5.706785877375826e8,3.9574872039228964e8,1.5492840670813686e8,2.6185082823910456e7,0}
      }
    },
    
    /* m=10 */
    {
      {
        {0,-0.26666666666666666,12.8,-81880,-2.1007407614607615e6,-2.095521238228438e7,-1.1023046737156177e8,-3.441285888596737e8,-6.709847600932401e8,-8.259552492307693e8,-6.240550771965812e8,-2.6430567975384617e8,-4.805557813706294e7,0,0,0,0},
        {0,0,-0.06666666666666667,6520.2,311067.7942501943,5.102019779331779e6,4.133440304335664e7,1.922698987114219e8,5.530782550526806e8,1.0170620137920746e9,1.1980522605003884e9,8.746782659530692e8,3.6041683602797204e8,6.407410418275058e7,0,0,0},
        {0,0,0,-199.6,-23628.784478266833,-730166.5007724302,-9.797468315151514e6,-7.051502323959962e7,-3.0318843028131086e8,-8.24417740343672e8,-1.4532290842782943e9,-1.6563077409054527e9,-1.1777150141972852e9,-4.749021839427396e8,-8.291942894238311e7,0,0},
        {0,0,0,1,703.3999221968262,54143.24552805296,1.3738612902969064e6,1.6423980970872264e7,1.0950013007528281e8,4.457761957446739e8,1.1633972193432798e9,1.9862208061391819e9,2.20653026587352e9,1.5363898975089884e9,6.088031756559181e8,1.0474033129564182e8,0},
        {0,0,0,0,-3.49874686716792,-1588.4598780648316,-100391.40281967774,-2.2721153274630425e6,-2.5192147588914696e7,-1.5919834323671788e8,-6.225945846062396e8,-1.5748847121862333e9,-2.622330288934644e9,-2.854181112514796e9,-1.9537500785578425e9,-7.631081280111047e8,-1.2967850541365178e8}
      },{
        {0.5333333333333333,-25.133333333333333,1228.2,271881.5229215229,5.463605097125097e6,4.5788857465734266e7,2.0806943674778554e8,5.705886187710955e8,9.891261404195805e8,1.0929306833255634e9,7.47197496172805e8,2.883334688223776e8,4.805557813706294e7,0,0,0,0},
        {0,0.13333333333333333,-39.53333333333333,-24135.788500388502,-905518.1986013986,-1.2458983344832946e7,-8.693429073752914e7,-3.539285428811189e8,-9.016469155505828e8,-1.4824022811648796e9,-1.5738201839888113e9,-1.0428727894327894e9,-3.9245388811934733e8,-6.407410418275058e7,0,0,0},
        {0,0,0.2,857.3689565336624,78373.47438182733,2.0127715456099457e6,2.3112727872974087e7,1.448205784474976e8,5.48772786971836e8,1.3280004404618127e9,2.1005893010457883e9,2.16389478497818e9,1.3996187132419581e9,5.163618984139312e8,8.291942894238311e7,0,0},
        {0,0,0,-5.799844393652443,-2765.6909199503625,-171565.7852751995,-3.67408829080517e6,-3.790738907893345e7,-2.2126713741740116e8,-7.971567635483366e8,-1.8574286571222606e9,-2.852811286882909e9,-2.870394025251496e9,-1.8211526732190146e9,-6.61173341303739e8,-1.0474033129564182e8,0},
        {0,0,0,-0.002506265664160401,19.04256314720711,6021.407418450143,310071.7180627422,5.959559314048181e6,5.72743914936333e7,3.179286576710175e8,1.1032734622114787e9,2.4971591341437187e9,3.7476056187814e9,3.700130737674165e9,2.310989422798335e9,8.279473807179306e8,1.2967850541365178e8}
      }
    }
  };

/* Compute the singular field at the point x for the particle at xp */
void effsource_phis(struct coordinate * x, double * phis)
{
  double A, alpha, rho2;

  double r      = x->r;
  double theta  = x->theta;
  double phi    = x->phi;
  double rp     = xp.r;
  double thetap = xp.theta;
  double phip   = xp.phi;

  double dr     = r - rp;
  double dtheta = theta - thetap;
  double dphi   = phi - phip;

  double dr2 = dr*dr;
  double dr4 = dr2*dr2;
  double dr6 = dr4*dr2;
  double dr8 = dr4*dr4;

  double dtheta2  = dtheta*dtheta;
  double dtheta4  = dtheta2*dtheta2;
  double dtheta8  = dtheta4*dtheta4;

  double dQ  = sin(0.5*dphi);
  double dQ2 = dQ*dQ;
  double dQ4 = dQ2*dQ2;
  double dQ8 = dQ4*dQ4;

  double dR  = sin(dphi);

  A = dQ8*(A0080 + A1080*dr) + (A6000 + A7000*dr)*dr6 + (A8000 + A9000*dr)*dr8 +
   (A4200 + dr*(A5200 + dr*(A6200 + A7200*dr)))*dr4*dtheta2 +
   ((A2400 + A3400*dr)*dr2 + (A4400 + A5400*dr)*dr4 + (A0600 + dr*(A1600 + dr*(A2600 + A3600*dr)))*dtheta2)*
    dtheta4 + dQ4*((A2040 + A3040*dr)*dr2 + (A4040 + A5040*dr)*dr4 +
      (A0240 + dr*(A1240 + dr*(A2240 + A3240*dr)))*dtheta2 +
      dQ2*(A0060 + A1060*dr + (A2060 + A3060*dr)*dr2 + (A0260 + A1260*dr)*dtheta2) + (A0440 + A1440*dr)*dtheta4) +
   dQ2*((A4020 + dr*(A5020 + dr*(A6020 + A7020*dr)))*dr4 +
      (A2220 + dr*(A3220 + dr*(A4220 + A5220*dr)))*dr2*dtheta2 +
      (A0420 + A1420*dr + (A2420 + A3420*dr)*dr2 + (A0620 + A1620*dr)*dtheta2)*dtheta4) +
   (A0800 + A1800*dr)*dtheta8 + dR*(A0081*dQ8 + (A6001 + A7001*dr)*dr6 + A8001*dr8 +
      (A4201 + dr*(A5201 + A6201*dr))*dr4*dtheta2 +
      ((A2401 + A3401*dr)*dr2 + A4401*dr4 + (A0601 + dr*(A1601 + A2601*dr))*dtheta2)*dtheta4 +
      dQ4*((A2041 + A3041*dr)*dr2 + A4041*dr4 + (A0241 + dr*(A1241 + A2241*dr))*dtheta2 +
         dQ2*(A0061 + A1061*dr + A2061*dr2 + A0261*dtheta2) + A0441*dtheta4) +
      dQ2*((A4021 + dr*(A5021 + A6021*dr))*dr4 + (A2221 + dr*(A3221 + A4221*dr))*dr2*dtheta2 +
         (A0421 + A1421*dr + A2421*dr2 + A0621*dtheta2)*dtheta4) + A0801*dtheta8);

  alpha = alpha20*dr2 + alpha02*dtheta2;
  rho2 = alpha + beta*dQ2;

  *phis = A/pow(rho2, 3.5);
}

/* Compute the singular field at the point x for the particle at xp */
void effsource_phis_m(int m, struct coordinate * x, double * phis)
{
  double A[5], num, alpha, ellE, ellK;

  double r      = x->r;
  const double theta  = x->theta;
  const double rp     = xp.r;
  const double thetap = xp.theta;

  const double dr     = r - rp;
  const double dtheta = theta - thetap;

  const double dr2 = dr*dr;

  const double dtheta2  = dtheta*dtheta;

  A[0] = 0;
  // Skip A801*pow(dr,8) + pow(dr,6)*(A601 + A701*dr) + pow(dr,4)*(A421 + A521*dr + A621*pow(dr,2))*pow(dtheta,2) + A081*pow(dtheta,8) + pow(dtheta,4)*(A441*pow(dr,4) + pow(dr,2)*(A241 + A341*dr) + (A061 + A161*dr + A261*pow(dr,2))*pow(dtheta,2));
  A[1] = 0;
  // Skip pow(dr,4)*(A403 + A503*dr + A603*pow(dr,2)) + (A423*pow(dr,4) + pow(dr,2)*(A223 + A323*dr))*pow(dtheta,2) + pow(dtheta,4)*(A043 + A143*dr + A243*pow(dr,2) + A063*pow(dtheta,2));
  A[2] = 0;
  // Skip A405*pow(dr,4) + pow(dr,2)*(A205 + A305*dr) + (A025 + A125*dr + A225*pow(dr,2))*pow(dtheta,2) + A045*pow(dtheta,4);
  A[3] = 0;
  // Skip A007 + A107*dr + A207*pow(dr,2) + A027*pow(dtheta,2);
  A[4] = 0;
  // Skip A009;

  alpha = alpha20*dr2 + alpha02*dtheta2;

  const double C1 = alpha / beta;

  double C[17];
  C[0]  = 1;
  C[1]  = C1;
  C[2]  = C[1]*C[1];
  C[3]  = C[2]*C[1];
  C[4]  = C[2]*C[2];
  C[5]  = C[3]*C[2];
  C[6]  = C[3]*C[3];
  C[7]  = C[4]*C[3];
  C[8]  = C[4]*C[4];
  C[9]  = C[5]*C[4];
  C[10] = C[5]*C[5];
  C[11] = C[6]*C[5];
  C[12] = C[6]*C[6];
  C[13] = C[7]*C[6];
  C[14] = C[7]*C[7];
  C[15] = C[8]*C[7];
  C[16] = C[8]*C[8];

  ellE = gsl_sf_ellint_Ecomp(sqrt(1.0/(1.0+C1)), GSL_PREC_DOUBLE);
  ellK = gsl_sf_ellint_Kcomp(sqrt(1.0/(1.0+C1)), GSL_PREC_DOUBLE);
  const double ellip[2] = {ellK, ellE};

  if(m>10)
  {
    printf("Support for computing mode %d has not yet been added.\n", m);
    return;
  }

  num = 0;
  for(int i=0; i<2; i++)
    for(int j=0; j<5; j++)
      for(int k=0; k<17; k++)
        num += EI[m][i][j][k]*ellip[i]*A[j]*C[k];

  *phis = 4.0*num/(beta*C[3]*pow(alpha+beta, 2.5));
}

/* Compute the singular field, its derivatives and its d'Alembertian */
void effsource_calc(struct coordinate * x, double *phis, double *dphis_dr,
      double *dphis_dth, double *dphis_dph, double *dphis_dt, double *box_phis)
{
  double A, dA_dr, d2A_dr2, dA_dth, d2A_dth2, dA_dR, dA_dph,  d2A_dR2,  d2A_dph2, dA_dt, d2A_dt2, d2A_dphdt;
  double s2, sqrts2, s2_15, s2_25, s2_35, s2_45, s2_55, ds2_dr, d2s2_dr2, ds2_dth, d2s2_dth2, ds2_dR, ds2_dph, d2s2_dR2, d2s2_dph2, ds2_dt, d2s2_dt2, d2s2_dphdt;
  double d2phis_dr2, d2phis_dth2, d2phis_dph2, d2phis_dt2, d2phis_dphdt;

  double r      = x->r;
  double theta  = x->theta;
  double phi    = x->phi;
  double rp     = xp.r;
  double thetap = xp.theta;
  double phip   = xp.phi;

  double dr     = r - rp;
  double dtheta = theta - thetap;
  double dphi   = phi - phip;

  double dr2 = dr*dr;
  double dr4 = dr2*dr2;
  double dr6 = dr4*dr2;
  double dr8 = dr4*dr4;

  double dtheta2  = dtheta*dtheta;
  double dtheta4  = dtheta2*dtheta2;
  double dtheta8  = dtheta4*dtheta4;

  double dQ  = sin(0.5*dphi);
  double dQ2 = dQ*dQ;
  double dQ4 = dQ2*dQ2;
  double dQ8 = dQ4*dQ4;

  double dR  = sin(dphi);

  /* A, dA/dx, d^2A/dx^2 */
  A         = 0;
  dA_dr     = 0;
  dA_dth    = 0;
  dA_dR     = 0;
  dA_dph    = 0;
  dA_dt     = 0;
  d2A_dr2   = 0;
  d2A_dth2  = 0;
  d2A_dph2  = 0;
  d2A_dt2   = 0;
  d2A_dphdt = 0;

  /* s, ds/dr, d^2s/dr^2 */
  s2         = alpha20*dr2 + alpha02*dtheta2 + beta*dQ2;
  ds2_dr     = 2*alpha20*dr;
  ds2_dth    = 2*alpha02*dtheta;
  ds2_dR     = 0;
  ds2_dph    = 0;
  ds2_dt     = 0;
  d2s2_dr2   = 0;
  d2s2_dth2  = 0;
  d2s2_dR2   = 0;
  d2s2_dph2  = 0;
  d2s2_dt2   = 0;
  d2s2_dphdt = 0;
  sqrts2     = sqrt(s2);
  s2_15      = s2*sqrts2;
  s2_25      = s2*s2_15;
  s2_35      = s2*s2_25;
  s2_45      = s2*s2_35;
  s2_55      = s2*s2_45;

  /* phis */
  *phis = A/s2_35;

  /* First derivatives of phis */
  *dphis_dr  = (-7*ds2_dr*A + 2*dA_dr*s2) /(2.*s2_45);
  *dphis_dth = (-7*ds2_dth*A + 2*dA_dth*s2)/(2.*s2_45);
  *dphis_dph = (-7*ds2_dph*A + 2*dA_dph*s2)/(2.*s2_45);
  *dphis_dt  = (-7*ds2_dt*A + 2*dA_dt*s2)/(2.*s2_45);
  
  /* Second derivatives of phis */
  d2phis_dr2 =
    (63*ds2_dr*ds2_dr*A - 14*s2*(2*dA_dr*ds2_dr + d2s2_dr2*A) + 4*d2A_dr2*s2*s2)/(4.*s2_55);
  d2phis_dth2 =
    (63*ds2_dth*ds2_dth*A - 14*s2*(2*dA_dth*ds2_dth + d2s2_dth2*A) + 4*d2A_dth2*s2*s2)/(4.*s2_55);
  d2phis_dph2 =
    (63*ds2_dph*ds2_dph*A - 14*s2*(2*dA_dph*ds2_dph + d2s2_dph2*A) + 4*d2A_dph2*s2*s2)/(4.*s2_55);
  d2phis_dt2 =
    (63*ds2_dt*ds2_dt*A - 14*s2*(2*dA_dt*ds2_dt + d2s2_dt2*A) + 4*d2A_dt2*s2*s2)/(4.*s2_55);
  d2phis_dphdt =
    (63*ds2_dph*ds2_dt*A - 14*s2*(dA_dt*ds2_dph + dA_dph*ds2_dt + d2s2_dphdt*A) + 4*d2A_dphdt*s2*s2)/(4.*s2_55);
  
  
  /* Box[phis] */
  double sinth  = sin(theta);
  double sinth2 = sinth*sinth;
  double sin2th = sin(2*theta);
  double cos2th = cos(2*theta);
  double r2 = r*r;
  double r3 = r2*r;
  double r4 = r2*r2;
  double a2 = a*a;
  double a4 = a2*a2;

  *box_phis = -((2*a2*(*dphis_dr) - a2*d2phis_dph2 - a4*d2phis_dr2 - a2*d2phis_dth2 - 4*(*dphis_dr)*r - 2*a2*(*dphis_dr)*r + 
         4*d2phis_dph2*r + 2*a*d2phis_dphdt*r + 4*a2*d2phis_dr2*r + 2*d2phis_dth2*r + 6*(*dphis_dr)*r2 - 2*d2phis_dph2*r2 - 4*d2phis_dr2*r2 - 
         2*a2*d2phis_dr2*r2 - d2phis_dth2*r2 - 2*(*dphis_dr)*r3 + 4*d2phis_dr2*r3 - d2phis_dr2*r4 + 
         (a4*d2phis_dt2 + 4*a*d2phis_dphdt*r + 2*d2phis_dt2*r4 + a2*d2phis_dt2*r*(2 + 3*r))*sinth2 + 
         cos2th*(a4*d2phis_dr2 - 2*a*d2phis_dphdt*r + (-2 + r)*r*(d2phis_dth2 + 2*(*dphis_dr)*(-1 + r) + d2phis_dr2*(-2 + r)*r) + 
            a2*(-d2phis_dph2 + d2phis_dth2 + 2*(*dphis_dr)*(-1 + r) - 4*d2phis_dr2*r + 2*d2phis_dr2*r2) + 
            a2*d2phis_dt2*(a2 + (-2 + r)*r)*sinth2) - a2*(*dphis_dth)*sin2th + 2*(*dphis_dth)*r*sin2th - 
         (*dphis_dth)*r2*sin2th))/((sinth2*(a2 + (-2 + r)*r)*(a2 + 2*r2 + a2*cos2th)));
}

/* Compute the 2D singular field, its derivatives and its d'Alembertian */
void effsource_calc_m(int m, struct coordinate * x, double *phis, double *dphis_dr,
      double *dphis_dth, double *dphis_dph, double *dphis_dt, double *box_phis)
{
  double A[5], alpha, ellE, ellK;
  double dA_dr[5], dalpha_dr, dC1_dr, dellE_dC, dellK_dC, d2ellE_dC2, d2ellK_dC2, dellE_dr, dellK_dr;
  double d2A_dr2[5], d2alpha_dr2, d2C1_dr2, d2ellE_dr2, d2ellK_dr2;
  double dA_dtheta[5], dalpha_dtheta, dC1_dtheta, dellE_dtheta, dellK_dtheta;
  double d2A_dtheta2[5], d2alpha_dtheta2, d2C1_dtheta2, d2ellE_dtheta2, d2ellK_dtheta2;

  double s, ds_dr, d2s_dr2, ds_dtheta, d2s_dtheta2;

  double d2phis_dr2, d2phis_dth2, d2phis_dph2, d2phis_dt2, d2phis_dphdt;

  const double r      = x->r;
  const double theta  = x->theta;
  const double rp     = xp.r;
  const double thetap = xp.theta;
  const double om       = M / (a*M + sqrt(M*pow(rp,3)));

  const double dr     = r - rp;
  const double dtheta = theta - thetap;

  const double dr2 = dr*dr;
  const double dr3 = dr2*dr;
  const double dr4 = dr2*dr2;
  const double dr5 = dr3*dr2;
  const double dr6 = dr3*dr3;
  const double dr7 = dr4*dr3;
  const double dr8 = dr4*dr4;

  const double dtheta2  = dtheta*dtheta;
  const double dtheta3  = dtheta2*dtheta;
  const double dtheta4  = dtheta2*dtheta2;
  const double dtheta5  = dtheta3*dtheta2;
  const double dtheta6  = dtheta3*dtheta3;
  const double dtheta7  = dtheta4*dtheta3;
  const double dtheta8  = dtheta4*dtheta4;

  /* Coefficients of sin(dphi) in the numerator */
  A[0] = 0;
  A[1] = 0;
  A[2] = 0;
  A[3] = 0;
  A[4] = 0;

  /* r derivatives of coefficients */
  dA_dr[0] = 0;
  dA_dr[1] = 0;
  dA_dr[2] = 0;
  dA_dr[3] = 0;
  dA_dr[4] = 0;

  /* r,r derivatives of coefficients */
  d2A_dr2[0] = 0;
  d2A_dr2[1] = 0;
  d2A_dr2[2] = 0;
  d2A_dr2[3] = 0;
  d2A_dr2[4] = 0;

  /* theta derivatives of coefficients */
  dA_dtheta[0] = 0;
  dA_dtheta[1] = 0;
  dA_dtheta[2] = 0;
  dA_dtheta[3] = 0;
  dA_dtheta[4] = 0;

  /* theta,theta derivatives of coefficients */
  d2A_dtheta2[0] = 0;
  d2A_dtheta2[1] = 0;
  d2A_dtheta2[2] = 0;
  d2A_dtheta2[3] = 0;
  d2A_dtheta2[4] = 0;

  /* alpha term appearing in the denominator */
  alpha = alpha20*dr2 + alpha02*dtheta2;

  /* Derivatives of alpha */
  dalpha_dr       = 2*alpha20*dr;
  d2alpha_dr2     = 2*alpha20;
  dalpha_dtheta   = 2*alpha02*dtheta;
  d2alpha_dtheta2 = 2*alpha02;

  /* C term appearing in Elliptic integrals and related power series in numerator */
  const double C1 = alpha / beta;

  double C[17];
  C[0]  = 1;
  C[1]  = C1;
  C[2]  = C1*C1;
  C[3]  = C[2]*C[1];
  C[4]  = C[2]*C[2];
  C[5]  = C[3]*C[2];
  C[6]  = C[3]*C[3];
  C[7]  = C[4]*C[3];
  C[8]  = C[4]*C[4];
  C[9]  = C[5]*C[4];
  C[10] = C[5]*C[5];
  C[11] = C[6]*C[5];
  C[12] = C[6]*C[6];
  C[13] = C[7]*C[6];
  C[14] = C[7]*C[7];
  C[15] = C[8]*C[7];
  C[16] = C[8]*C[8];

  dC1_dr       = dalpha_dr / beta;
  d2C1_dr2     = d2alpha_dr2 / beta;
  dC1_dtheta   = dalpha_dtheta / beta;
  d2C1_dtheta2 = d2alpha_dtheta2 / beta;

  double dC_dr[17];
  dC_dr[0]  = 0;
  dC_dr[1]  = 1*C[0]*dC1_dr;
  dC_dr[2]  = 2*C[1]*dC1_dr;
  dC_dr[3]  = 3*C[2]*dC1_dr;
  dC_dr[4]  = 4*C[3]*dC1_dr;
  dC_dr[5]  = 5*C[4]*dC1_dr;
  dC_dr[6]  = 6*C[5]*dC1_dr;
  dC_dr[7]  = 7*C[6]*dC1_dr;
  dC_dr[8]  = 8*C[7]*dC1_dr;
  dC_dr[9]  = 9*C[8]*dC1_dr;
  dC_dr[10] = 10*C[9]*dC1_dr;
  dC_dr[11] = 11*C[10]*dC1_dr;
  dC_dr[12] = 12*C[11]*dC1_dr;
  dC_dr[13] = 13*C[12]*dC1_dr;
  dC_dr[14] = 14*C[13]*dC1_dr;
  dC_dr[15] = 15*C[14]*dC1_dr;
  dC_dr[16] = 16*C[15]*dC1_dr;

  double d2C_dr2[17];
  d2C_dr2[0]  = 0;
  d2C_dr2[1]  = d2C1_dr2;
  d2C_dr2[2]  = 2*1*C[0]*dC1_dr*dC1_dr + 2*C[1]*d2C1_dr2;
  d2C_dr2[3]  = 3*2*C[1]*dC1_dr*dC1_dr + 3*C[2]*d2C1_dr2;
  d2C_dr2[4]  = 4*3*C[2]*dC1_dr*dC1_dr + 4*C[3]*d2C1_dr2;
  d2C_dr2[5]  = 5*4*C[3]*dC1_dr*dC1_dr + 5*C[4]*d2C1_dr2;
  d2C_dr2[6]  = 6*5*C[4]*dC1_dr*dC1_dr + 6*C[5]*d2C1_dr2;
  d2C_dr2[7]  = 7*6*C[5]*dC1_dr*dC1_dr + 7*C[6]*d2C1_dr2;
  d2C_dr2[8]  = 8*7*C[6]*dC1_dr*dC1_dr + 8*C[7]*d2C1_dr2;
  d2C_dr2[9]  = 9*8*C[7]*dC1_dr*dC1_dr + 9*C[8]*d2C1_dr2;
  d2C_dr2[10] = 10*9*C[8]*dC1_dr*dC1_dr + 10*C[9]*d2C1_dr2;
  d2C_dr2[11] = 11*10*C[9]*dC1_dr*dC1_dr + 11*C[10]*d2C1_dr2;
  d2C_dr2[12] = 12*11*C[10]*dC1_dr*dC1_dr + 12*C[11]*d2C1_dr2;
  d2C_dr2[13] = 13*12*C[11]*dC1_dr*dC1_dr + 13*C[12]*d2C1_dr2;
  d2C_dr2[14] = 14*13*C[12]*dC1_dr*dC1_dr + 14*C[13]*d2C1_dr2;
  d2C_dr2[15] = 15*14*C[13]*dC1_dr*dC1_dr + 15*C[14]*d2C1_dr2;
  d2C_dr2[16] = 16*15*C[14]*dC1_dr*dC1_dr + 16*C[15]*d2C1_dr2;

  double dC_dtheta[17];
  dC_dtheta[0]  = 0;
  dC_dtheta[1]  = 1*C[0]*dC1_dtheta;
  dC_dtheta[2]  = 2*C[1]*dC1_dtheta;
  dC_dtheta[3]  = 3*C[2]*dC1_dtheta;
  dC_dtheta[4]  = 4*C[3]*dC1_dtheta;
  dC_dtheta[5]  = 5*C[4]*dC1_dtheta;
  dC_dtheta[6]  = 6*C[5]*dC1_dtheta;
  dC_dtheta[7]  = 7*C[6]*dC1_dtheta;
  dC_dtheta[8]  = 8*C[7]*dC1_dtheta;
  dC_dtheta[9]  = 9*C[8]*dC1_dtheta;
  dC_dtheta[10] = 10*C[9]*dC1_dtheta;
  dC_dtheta[11] = 11*C[10]*dC1_dtheta;
  dC_dtheta[12] = 12*C[11]*dC1_dtheta;
  dC_dtheta[13] = 13*C[12]*dC1_dtheta;
  dC_dtheta[14] = 14*C[13]*dC1_dtheta;
  dC_dtheta[15] = 15*C[14]*dC1_dtheta;
  dC_dtheta[16] = 16*C[15]*dC1_dtheta;

  double d2C_dtheta2[17];
  d2C_dtheta2[0]  = 0;
  d2C_dtheta2[1]  = d2C1_dtheta2;
  d2C_dtheta2[2]  = 2*1*C[0]*dC1_dtheta*dC1_dtheta + 2*C[1]*d2C1_dtheta2;
  d2C_dtheta2[3]  = 3*2*C[1]*dC1_dtheta*dC1_dtheta + 3*C[2]*d2C1_dtheta2;
  d2C_dtheta2[4]  = 4*3*C[2]*dC1_dtheta*dC1_dtheta + 4*C[3]*d2C1_dtheta2;
  d2C_dtheta2[5]  = 5*4*C[3]*dC1_dtheta*dC1_dtheta + 5*C[4]*d2C1_dtheta2;
  d2C_dtheta2[6]  = 6*5*C[4]*dC1_dtheta*dC1_dtheta + 6*C[5]*d2C1_dtheta2;
  d2C_dtheta2[7]  = 7*6*C[5]*dC1_dtheta*dC1_dtheta + 7*C[6]*d2C1_dtheta2;
  d2C_dtheta2[8]  = 8*7*C[6]*dC1_dtheta*dC1_dtheta + 8*C[7]*d2C1_dtheta2;
  d2C_dtheta2[9]  = 9*8*C[7]*dC1_dtheta*dC1_dtheta + 9*C[8]*d2C1_dtheta2;
  d2C_dtheta2[10] = 10*9*C[8]*dC1_dtheta*dC1_dtheta + 10*C[9]*d2C1_dtheta2;
  d2C_dtheta2[11] = 11*10*C[9]*dC1_dtheta*dC1_dtheta + 11*C[10]*d2C1_dtheta2;
  d2C_dtheta2[12] = 12*11*C[10]*dC1_dtheta*dC1_dtheta + 12*C[11]*d2C1_dtheta2;
  d2C_dtheta2[13] = 13*12*C[11]*dC1_dtheta*dC1_dtheta + 13*C[12]*d2C1_dtheta2;
  d2C_dtheta2[14] = 14*13*C[12]*dC1_dtheta*dC1_dtheta + 14*C[13]*d2C1_dtheta2;
  d2C_dtheta2[15] = 15*14*C[13]*dC1_dtheta*dC1_dtheta + 15*C[14]*d2C1_dtheta2;
  d2C_dtheta2[16] = 16*15*C[14]*dC1_dtheta*dC1_dtheta + 16*C[15]*d2C1_dtheta2;

  /* Elliptic integrals */
  ellE = gsl_sf_ellint_Ecomp(sqrt(1.0/(1.0+C1)), GSL_PREC_DOUBLE);
  ellK = gsl_sf_ellint_Kcomp(sqrt(1.0/(1.0+C1)), GSL_PREC_DOUBLE);
  const double ellip[2] = {ellK, ellE};

  /* Derivatives of elliptic integrals */
  dellE_dC   = (ellK - ellE)/(2.*(1+C1));
  dellK_dC   = (C1*ellK - (1+C1)*ellE)/(2.*C1*(1+C1));
  d2ellE_dC2 = -(2*C1*ellK - (2*C1-1)*ellE)/(4.*C1*(1+C1)*(1+C1));
  d2ellK_dC2 = -(C1*(1+2*C1)*ellK - 2*(1+C1)*(1+C1)*ellE)/(4.*C1*C1*(1+C1)*(1+C1));

  dellE_dr       = dellE_dC * dC1_dr;
  dellE_dtheta   = dellE_dC * dC1_dtheta;
  d2ellE_dr2     = d2ellE_dC2 * dC1_dr * dC1_dr + dellE_dC * d2C1_dr2;
  d2ellE_dtheta2 = d2ellE_dC2 * dC1_dtheta * dC1_dtheta + dellE_dC * d2C1_dtheta2;

  dellK_dr       = dellK_dC * dC1_dr;
  dellK_dtheta   = dellK_dC * dC1_dtheta;
  d2ellK_dr2     = d2ellK_dC2 * dC1_dr * dC1_dr + dellK_dC * d2C1_dr2;
  d2ellK_dtheta2 = d2ellK_dC2 * dC1_dtheta * dC1_dtheta + dellK_dC * d2C1_dtheta2;

  const double dellip_dr[2] = {dellK_dr, dellE_dr};
  const double dellip_dtheta[2] = {dellK_dtheta, dellE_dtheta};

  const double d2ellip_dr2[2] = {d2ellK_dr2, d2ellE_dr2};
  const double d2ellip_dtheta2[2] = {d2ellK_dtheta2, d2ellE_dtheta2};

  if(m>10)
  {
    printf("Support for computing mode %d has not yet been added.\n", m);
    return;
  }

  /* Numerator */
  double num = 0;
  for(int i=0; i<2; i++)
    for(int j=0; j<5; j++)
      for(int k=0; k<17; k++)
        num += EI[m][i][j][k]*ellip[i]*A[j]*C[k];
  double dnum_dr = 0;
  for(int i=0; i<2; i++)
    for(int j=0; j<5; j++)
      for(int k=0; k<17; k++)
        dnum_dr += EI[m][i][j][k]*
            (dellip_dr[i]*A[j]*C[k]
           + ellip[i]*dA_dr[j]*C[k]
           + ellip[i]*A[j]*dC_dr[k]);
  double d2num_dr2 = 0;
  for(int i=0; i<2; i++)
    for(int j=0; j<5; j++)
      for(int k=0; k<17; k++)
        d2num_dr2 += EI[m][i][j][k]*
            (d2ellip_dr2[i]*A[j]*C[k]
           + dellip_dr[i]*dA_dr[j]*C[k]
           + dellip_dr[i]*A[j]*dC_dr[k]
           + dellip_dr[i]*dA_dr[j]*C[k]
           + ellip[i]*d2A_dr2[j]*C[k]
           + ellip[i]*dA_dr[j]*dC_dr[k]
           + dellip_dr[i]*A[j]*dC_dr[k]
           + ellip[i]*dA_dr[j]*dC_dr[k]
           + ellip[i]*A[j]*d2C_dr2[k]);
  double dnum_dtheta = 0;
  for(int i=0; i<2; i++)
    for(int j=0; j<5; j++)
      for(int k=0; k<17; k++)
        dnum_dtheta += EI[m][i][j][k]*
            (dellip_dtheta[i]*A[j]*C[k]
           + ellip[i]*dA_dtheta[j]*C[k]
           + ellip[i]*A[j]*dC_dtheta[k]);
  double d2num_dtheta2 = 0;
  for(int i=0; i<2; i++)
    for(int j=0; j<5; j++)
      for(int k=0; k<17; k++)
        d2num_dtheta2 += EI[m][i][j][k]*
            (d2ellip_dtheta2[i]*A[j]*C[k]
           + dellip_dtheta[i]*dA_dtheta[j]*C[k]
           + dellip_dtheta[i]*A[j]*dC_dtheta[k]
           + dellip_dtheta[i]*dA_dtheta[j]*C[k]
           + ellip[i]*d2A_dtheta2[j]*C[k]
           + ellip[i]*dA_dtheta[j]*dC_dtheta[k]
           + dellip_dtheta[i]*A[j]*dC_dtheta[k]
           + ellip[i]*dA_dtheta[j]*dC_dtheta[k]
           + ellip[i]*A[j]*d2C_dtheta2[k]);

  /* Denominator */
  s        = beta*C[3]*pow(alpha+beta, 2.5);
  ds_dr    = beta*(3*C[2]*pow(alpha+beta, 2.5)*dC1_dr + C[3]*2.5*pow(alpha+beta, 1.5)*dalpha_dr);
  ds_dtheta   = beta*(3*C[2]*pow(alpha+beta, 2.5)*dC1_dtheta + C[3]*2.5*pow(alpha+beta, 1.5)*dalpha_dtheta);
  d2s_dr2  = beta*(6*C1*pow(alpha+beta, 2.5)*dC1_dr*dC1_dr
               + 3*C[2]*2.5*pow(alpha+beta, 1.5)*dalpha_dr*dC1_dr
               + 3*C[2]*pow(alpha+beta, 2.5)*d2C1_dr2
               + 3*C[2]*dC1_dr*2.5*pow(alpha+beta, 1.5)*dalpha_dr
               + C[3]*2.5*1.5*pow(alpha+beta, 0.5)*dalpha_dr*dalpha_dr
               + C[3]*2.5*pow(alpha+beta, 1.5)*d2alpha_dr2);
  d2s_dtheta2 = beta*(6*C1*pow(alpha+beta, 2.5)*dC1_dtheta*dC1_dtheta
               + 3*C[2]*2.5*pow(alpha+beta, 1.5)*dalpha_dtheta*dC1_dtheta
               + 3*C[2]*pow(alpha+beta, 2.5)*d2C1_dtheta2
               + 3*C[2]*dC1_dtheta*2.5*pow(alpha+beta, 1.5)*dalpha_dtheta
               + C[3]*2.5*1.5*pow(alpha+beta, 0.5)*dalpha_dtheta*dalpha_dtheta
               + C[3]*2.5*pow(alpha+beta, 1.5)*d2alpha_dtheta2);

  /* Singular field */
  *phis = 4.0*num/s;

  /* First derivatives of phis */
  *dphis_dr  = 4.0*(-ds_dr*num + dnum_dr*s) /(s*s);
  *dphis_dth = 4.0*(-ds_dtheta*num + dnum_dtheta*s)/(s*s);
  *dphis_dt  = - m * om * (*phis); // This should be interpreted as pure-imaginary
  *dphis_dph = m * (*phis); // This should be interpreted as pure-imaginary

  /* Second derivatives of phis */
  d2phis_dr2   = 4.0*(2.0*ds_dr*ds_dr*num - s*(2*dnum_dr*ds_dr + d2s_dr2*num) + d2num_dr2*s*s)/(s*s*s);
  d2phis_dth2  = 4.0*(2.0*ds_dtheta*ds_dtheta*num - s*(2*dnum_dtheta*ds_dtheta + d2s_dtheta2*num) + d2num_dtheta2*s*s)/(s*s*s);
  d2phis_dph2  = - m*m*(*phis);
  d2phis_dt2   = - m*m*om*om*(*phis);
  d2phis_dphdt = m*m*om*(*phis);

  /* Box[phis] */
  double sinth  = sin(theta);
  double sinth2 = sinth*sinth;
  double sin2th = sin(2*theta);
  double cos2th = cos(2*theta);
  double r2 = r*r;
  double r3 = r2*r;
  double r4 = r2*r2;
  double a2 = a*a;
  double a4 = a2*a2;

  *box_phis = -((2*a2*(*dphis_dr) - a2*d2phis_dph2 - a4*d2phis_dr2 - a2*d2phis_dth2 - 4*(*dphis_dr)*r - 2*a2*(*dphis_dr)*r + 
         4*d2phis_dph2*r + 2*a*d2phis_dphdt*r + 4*a2*d2phis_dr2*r + 2*d2phis_dth2*r + 6*(*dphis_dr)*r2 - 2*d2phis_dph2*r2 - 4*d2phis_dr2*r2 - 
         2*a2*d2phis_dr2*r2 - d2phis_dth2*r2 - 2*(*dphis_dr)*r3 + 4*d2phis_dr2*r3 - d2phis_dr2*r4 + 
         (a4*d2phis_dt2 + 4*a*d2phis_dphdt*r + 2*d2phis_dt2*r4 + a2*d2phis_dt2*r*(2 + 3*r))*sinth2 + 
         cos2th*(a4*d2phis_dr2 - 2*a*d2phis_dphdt*r + (-2 + r)*r*(d2phis_dth2 + 2*(*dphis_dr)*(-1 + r) + d2phis_dr2*(-2 + r)*r) + 
            a2*(-d2phis_dph2 + d2phis_dth2 + 2*(*dphis_dr)*(-1 + r) - 4*d2phis_dr2*r + 2*d2phis_dr2*r2) + 
            a2*d2phis_dt2*(a2 + (-2 + r)*r)*sinth2) - a2*(*dphis_dth)*sin2th + 2*(*dphis_dth)*r*sin2th - 
         (*dphis_dth)*r2*sin2th))/((sinth2*(a2 + (-2 + r)*r)*(a2 + 2*r2 + a2*cos2th)));
}
